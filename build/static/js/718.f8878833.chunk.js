"use strict";(self.webpackChunkmypima_front=self.webpackChunkmypima_front||[]).push([[718],{3095:function(e,n,t){t.d(n,{Cb:function(){return h},NN:function(){return _},Q8:function(){return m},U:function(){return p},uK:function(){return f},w8:function(){return g}});var r,a,i,s,o,c,l,d=t(30168),u=t(9383),m=((0,u.Ps)(r||(r=(0,d.Z)(["\n  query GetParticipantsAttendanceByProject($projectId: String!) {\n    getParticipantsByProject(project_id: $projectId) {\n      message\n      status\n      participants {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        age\n        coffee_tree_numbers\n        coop_membership_number\n        phone_number\n        hh_number\n        ffg_id\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n        create_in_commcare\n      }\n    }\n    getAttendances(project_id: $projectId) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_name\n        attendance_date\n        attendance_status\n        session_id\n        module_name\n        module_number\n        module_id\n      }\n    }\n  }\n"]))),(0,u.Ps)(a||(a=(0,d.Z)(["\n  query GetParticipantsAttendanceByProject($projectId: String!) {\n    getParticipantsByProject(project_id: $projectId) {\n      message\n      status\n      participants {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        age\n        coffee_tree_numbers\n        number_of_coffee_plots\n        coop_membership_number\n        phone_number\n        hh_number\n        ffg_id\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n        create_in_commcare\n      }\n    }\n  }\n"])))),p=(0,u.Ps)(i||(i=(0,d.Z)(["\n  query GetParticipantsByGroup($tgId: String!) {\n    getParticipantsByGroup(tg_id: $tgId) {\n      message\n      status\n      participants {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n      }\n    }\n  }\n"]))),f=(0,u.Ps)(s||(s=(0,d.Z)(["\n  query GetParticipantsById($id: String!) {\n    getParticipantsById(p_id: $id) {\n      message\n      status\n      participant {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n      }\n    }\n  }\n"]))),_=(0,u.Ps)(o||(o=(0,d.Z)(["\n  query GetAttendanceByParticipant($participantId: String!) {\n    getAttendanceByParticipant(participant_id: $participantId) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_name\n        attendance_date\n        attendance_status\n        module_name\n        session_id\n      }\n    }\n  }\n"]))),h=(0,u.Ps)(c||(c=(0,d.Z)(["\n  mutation UploadParticipants($partsFile: Upload!) {\n    uploadParticipants(parts_file: $partsFile) {\n      message\n      status\n      file\n    }\n  }\n"]))),g=(0,u.Ps)(l||(l=(0,d.Z)(["\n  mutation SyncParticipantsWithCOMMCARE($projectId: String!) {\n    syncParticipantsWithCOMMCARE(project_id: $projectId) {\n      message\n      status\n    }\n  }\n"])))},44879:function(e,n,t){t.r(n),t.d(n,{default:function(){return F}});var r,a=t(74165),i=t(37762),s=t(93433),o=t(15861),c=t(29439),l=t(72791),d=t(81918),u=t(65770),m=t(56355),p=t(16029),f=t(4567),_=t(19658),h=t(78914),g=t(5574),b=t(39157),x=t(97123),j=t(23110),v=t(78820),y=t(7692),Z=t(84376),P=t(32543),k=t(64802),w=t(3095),S=t(80184),C=["Project","first_name","last_name","gender","age","coffee_tree_numbers","farmer_sf_id","tns_id","hh_number","sf_household_id","farmer_number","ffg_id","training_group","status"],I=function(e){var n,t,r=e.open,i=e.setOpen,u=e.navigatedProject,I=e.sfProjectId,N=(0,l.useState)(null),A=(0,c.Z)(N,2),B=A[0],$=A[1],F=(0,l.useState)(null),D=(0,c.Z)(F,2),O=(D[0],D[1]),E=(0,l.useState)([]),M=(0,c.Z)(E,2),G=M[0],z=M[1],U=(0,l.useState)([]),T=(0,c.Z)(U,2),R=T[0],q=T[1],Q=(0,l.useState)(null),V=(0,c.Z)(Q,2),H=V[0],J=V[1],W=(0,l.useState)(!1),K=(0,c.Z)(W,2),L=K[0],Y=K[1],X=(0,Z.D)(w.Cb),ee=(0,c.Z)(X,1)[0],ne=(0,P.a)(w.Q8,{variables:{projectId:I}}),te=function(e){var n=new FileReader;n.onload=function(n){var t=n.target.result.split(/\r\n|\n/),r=t.map((function(e){return e.split(",").map((function(e){return e.replace(/^"(.*)"$/,"$1")}))}));$({filename:e.name,size:e.size,type:e.type,data:r.length>0?r:t}),z(r[0])},n.readAsText(e)};(0,l.useEffect)((function(){B&&(B.data&&B.data.length<2||re(B))}),[B,G]);var re=function(e){var n=e.data.map((function(e){return e[G.indexOf("Project")]})).filter((function(e){return e}));q((0,s.Z)(new Set(n)))},ae=function(e,n){"backdropClick"!==n&&"escapeKeyDown"!==n&&ie()},ie=function(){$(null),i(!1)},se=function(e,n,t){var r=n.indexOf("Project"),a=e.data.filter((function(e){return e[r]===t})),i="".concat(n.join(","),"\n").concat(a.join("\n"));return new File([i],e.filename,{type:"text/csv"})},oe=function(e){return(t=t||(0,o.Z)((0,a.Z)().mark((function e(n){var t;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ee({variables:{partsFile:n}});case 3:return t=e.sent,e.next=6,ne.refetch();case 6:J(t.data.uploadParticipants),200===t.data.uploadParticipants.status&&setTimeout((function(){window.location.reload()}),5e3),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error(e.t0),J({status:500,message:"Something went wrong. Please try again."});case 14:return e.prev=14,Y(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[0,10,14,17]])})))).apply(this,arguments)},ce=function(){var e=H.file;H.message;if(e){var n=atob(e),t=new Array(n.length).fill().map((function(e,t){return n.charCodeAt(t)})),r=new Uint8Array(t),a=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});(0,k.saveAs)(a,"error_file.xlsx")}else console.error("No file found in the upload result.")},le=function(e){return e>1e6?"".concat((e/1e6).toFixed(2)," MB"):"".concat((e/1e3).toFixed(2)," KB")},de=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};return(0,S.jsxs)(g.Z,{open:r,onClose:ae,children:[(0,S.jsx)(b.Z,{children:B?H?(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},className:"file-info",children:[(0,S.jsx)(f.Z,{variant:"body2",children:(0,S.jsx)(_.Z,{severity:200===H.status?"success":"error",children:H.message})}),200!==H.status&&H.file&&(0,S.jsx)(h.Z,{onClick:ce,variant:"contained",color:"primary",children:"Download Error File"})]}):G.filter((function(e){return C.includes(e)})).length!==C.length?(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,S.jsxs)(f.Z,{variant:"body1",children:[(0,S.jsx)(y.tJu,{style:{fontSize:"2rem",color:"#B90101"}})," File must contain all required columns:"]}),(0,S.jsx)(f.Z,{variant:"body2",sx:{display:"flex",alignItems:"center",flexWrap:"wrap"},children:C.filter((function(e){return!G.includes(e)})).map((function(e,n){return(0,S.jsx)(d.Z,{label:e,sx:{margin:"5px 0.5rem"},color:"primary",variant:"outlined"},n)}))}),(0,S.jsx)("div",{className:"upload_actions",children:(0,S.jsx)(v.SV5,{onClick:function(){return $(null)},className:"back__icon",title:"Back to Upload New File"})})]}):B.data.length-2<1?(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,S.jsxs)(f.Z,{variant:"body1",sx:{fontStyle:"italic"},children:[(0,S.jsx)(y.tJu,{style:{fontSize:"1.5rem",color:"#B90101"}})," There are no records in the file. Please upload a file with data."]}),(0,S.jsx)("div",{className:"upload_actions",children:(0,S.jsx)(v.SV5,{onClick:function(){return $(null)},className:"back__icon",title:"Back to Upload New File"})})]}):R.includes(u)?(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},className:"file-info",children:[(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,S.jsxs)(f.Z,{variant:"body2",children:[(0,S.jsx)("strong",{children:"Name:"})," ",B.filename]}),(0,S.jsxs)(f.Z,{variant:"body2",children:[(0,S.jsx)("strong",{children:"Size:"})," ",le(B.size)]}),(0,S.jsxs)(f.Z,{variant:"body2",children:[(0,S.jsx)("strong",{children:"Type:"})," ",B.type]}),(0,S.jsxs)(f.Z,{variant:"body2",children:[(0,S.jsx)("strong",{children:"Total Records:"})," ",de(B.data.length-2)]}),R.length>1&&(0,S.jsxs)(f.Z,{variant:"body4",sx:{marginBottom:"10px"},children:["Only records for ",(0,S.jsxs)("strong",{children:[u," (",B.data.filter((function(e){return e[G.indexOf("Project")]===u})).length," records)"]})," will be processed from this file."]})]}),(0,S.jsx)("div",{className:"upload_actions",children:L?(0,S.jsx)(f.Z,{variant:"body2",sx:{marginBottom:"10px",width:"100%",textAlign:"center"},children:(0,S.jsx)("em",{style:{fontWeight:"bold",color:"#6C757D"},children:"Data are being processed, wait..."})}):(0,S.jsxs)(S.Fragment,{children:[(0,S.jsx)(v.SV5,{onClick:function(){return $(null)},className:"back__icon",title:"Back to Upload New File"}),(0,S.jsx)(m.Qvc,{title:"Proceed Records Processing",className:"upload__icon",onClick:function(){return(n=n||(0,o.Z)((0,a.Z)().mark((function e(){var n;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!L){e.next=2;break}return e.abrupt("return");case 2:return Y(!0),J(null),n=se(B,G,u),e.next=7,oe(n);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}})]})})]}):(0,S.jsxs)(p.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,S.jsxs)(f.Z,{variant:"body1",sx:{fontStyle:"italic"},children:[(0,S.jsx)(y.tJu,{style:{fontSize:"3rem",color:"#B90101"}})," The project(s) in the file does not match the project you are currently navigating. Please upload a file with the correct project."]}),(0,S.jsx)("div",{className:"upload_actions",children:(0,S.jsx)(v.SV5,{onClick:function(){return $(null)},className:"back__icon",title:"Back to Upload New File"})})]}):(0,S.jsx)(j.b,{label:"Drag and drop or browse a file to upload. File must be: ",handleChange:function(e){O(e),J(null),te(e)},name:"file",types:["csv"]})}),(0,S.jsx)(x.Z,{children:(0,S.jsx)(h.Z,{onClick:ae,disabled:L,children:"Cancel"})})]})},N=t(30168),A=(0,t(9383).Ps)(r||(r=(0,N.Z)(["\n  query GetAttendances($projectId: String!, $limit: Int, $offset: Int) {\n    getAttendances(project_id: $projectId, limit: $limit, offset: $offset) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_status\n        module_name\n        module_number\n        module_id\n      }\n    }\n  }\n"]))),B=t(56789),$=t(61889),F=function(e){var n,t=e.selectedProject,r=e.trainingGroups,p=e.projects,f=(0,l.useState)(!1),_=(0,c.Z)(f,2),h=_[0],g=_[1],b=(0,l.useState)(),x=(0,c.Z)(b,2),j=x[0],v=x[1],y=(0,l.useState)(!1),k=(0,c.Z)(y,2),C=k[0],N=k[1],F=(0,P.a)(w.Q8,{variables:{projectId:t},skip:!t}),D=F.data,O=F.loading,E=F.error,M=F.refetch,G=(0,l.useState)([]),z=(0,c.Z)(G,2),U=z[0],T=z[1],R=(0,l.useState)(!0),q=(0,c.Z)(R,2),Q=q[0],V=q[1],H=(0,l.useState)(null),J=(0,c.Z)(H,2),W=J[0],K=J[1],L=(0,P.a)(A,{variables:{projectId:t,limit:5e3,offset:0},skip:!t,notifyOnNetworkStatusChange:!0}).fetchMore;(0,l.useEffect)((function(){var e;!function(){(e=e||(0,o.Z)((0,a.Z)().mark((function e(){var n,r,o,c,l,d,u,m,p,f,_,h,g,b,x,j;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(t){e.next=2;break}return e.abrupt("return");case 2:return e.prev=2,V(!0),K(null),r=5e3,o=0,c=[],e.next=10,L({variables:{projectId:t,limit:r,offset:o}});case 10:if(l=e.sent,d=l.data,u=(null===d||void 0===d||null===(n=d.getAttendances)||void 0===n?void 0:n.attendance)||[],c=(0,s.Z)(u),!(u.length<r)){e.next=17;break}return T(c),e.abrupt("return",V(!1));case 17:o+=r,m=10,p=!0;case 20:if(!p){e.next=37;break}f=[],_=(0,a.Z)().mark((function e(){var n,i;return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:i=L({variables:{projectId:t,limit:r,offset:n=o+h*r}}).then((function(e){var t,r;return{chunk:(null===e||void 0===e||null===(t=e.data)||void 0===t||null===(r=t.getAttendances)||void 0===r?void 0:r.attendance)||[],currentOffset:n}})),f.push(i);case 3:case"end":return e.stop()}}),e)})),h=0;case 24:if(!(h<m)){e.next=29;break}return e.delegateYield(_(),"t0",26);case 26:h++,e.next=24;break;case 29:return e.next=31,Promise.all(f);case 31:g=e.sent,b=(0,i.Z)(g);try{for(b.s();!(x=b.n()).done;)(j=x.value).chunk.length>0&&(c=[].concat((0,s.Z)(c),(0,s.Z)(j.chunk))),j.chunk.length<r&&(p=!1)}catch(v){b.e(v)}finally{b.f()}o+=m*r,e.next=20;break;case 37:T(c),e.next=44;break;case 40:e.prev=40,e.t1=e.catch(2),console.error("Parallel attendance fetch error:",e.t1),K(e.t1);case 44:return e.prev=44,V(!1),e.finish(44);case 47:case"end":return e.stop()}}),e,null,[[2,40,44,47]])})))).apply(this,arguments)}()}),[t,L]);var Y=(0,Z.D)(w.w8),X=(0,c.Z)(Y,1)[0],ee=JSON.parse(window.localStorage.getItem("myPimaUserData"));(0,l.useEffect)((function(){if(D&&200===D.getParticipantsByProject.status){var e=D.getParticipantsByProject.participants.filter((function(e){return"false"===e.create_in_commcare}));v(e.length)}}),[D]);if(O||Q)return(0,S.jsxs)($.ZP,{container:!0,direction:"column",justifyContent:"center",alignItems:"center",style:{height:"100vh"},children:[(0,S.jsx)(B.Z,{color:"#0D3C61",size:15}),(0,S.jsx)("em",{style:{color:"#0D3C61"},children:"Loading Participants and Attendances..."})]});if(E||W)return(0,S.jsx)($.ZP,{container:!0,direction:"column",justifyContent:"center",alignItems:"center",style:{height:"100vh"},children:(0,S.jsxs)("em",{style:{color:"red"},children:["Error loading data:"," ",(null===E||void 0===E?void 0:E.message)||(null===W||void 0===W?void 0:W.message)]})});var ne=D.getParticipantsByProject.participants,te=[{id:"num",name:"No.",selector:function(e){return e.num},sortable:!0},{id:"full_name",name:"Full Name",selector:function(e){return e.first_name+" "+e.last_name},sortable:!0},{id:"gender",name:"Gender",selector:function(e){return"m"===e.gender?"Male":"Female"},sortable:!0},{id:"location",name:"Location",selector:function(e){return e.location},sortable:!0},{id:"tns_id",name:"TNS ID",selector:function(e){return e.tns_id},sortable:!0},{id:"training_group",name:"Training Group",selector:function(e){return e.training_group},sortable:!0},{id:"household_id",name:"HH Number",selector:function(e){return e.hh_number},sortable:!0},{id:"primary_household_member",name:"Primary HouseHold Member",selector:function(e){return(0,S.jsx)("div",{children:"1"===e.farmer_number?(0,S.jsx)(d.Z,{label:"1",color:"success",variant:"outlined"}):(0,S.jsx)(d.Z,{label:"2",color:"error",variant:"outlined"})})},sortable:!0},{id:"farmer_trainer",name:"Farmer Trainer",selector:function(e){return e.farmer_trainer},sortable:!0},{id:"business_advisor",name:"Business Advisor",selector:function(e){return e.business_advisor},sortable:!0}],re=ne.map((function(e,n){var a,i={num:n+1,Project:p.find((function(e){return e.sf_project_id===t})).project_name,p_id:e.p_id,first_name:e.first_name,middle_name:e.middle_name?e.middle_name:"",last_name:e.last_name?e.last_name:"",gender:e.gender,age:e.age,coffee_tree_numbers:e.coffee_tree_numbers,phone_number:e.phone_number,farmer_sf_id:e.p_id,hh_number:e.hh_number,sf_household_id:e.household_id,ffg_id:e.ffg_id,location:e.location,tns_id:e.tns_id,training_group:r&&r.length>0&&(null===(a=r.find((function(n){return n.tg_id===e.training_group})))||void 0===a?void 0:a.tg_name)||"N/A",farmer_number:e.primary_household_member,status:e.status,farmer_trainer:e.farmer_trainer,create_in_commcare:e.create_in_commcare,number_of_coffee_plots:e.number_of_coffee_plots};return"a0EOj000003E0knMAC"===t?i.agronomy_advisor=e.business_advisor:i.business_advisor=e.business_advisor,"a0EOj000002FMGnMAO"===t||"a0EOj000002C7ivMAC"===t?i.national_identification_id=e.coop_membership_number?e.coop_membership_number:"":"a0EOj000003E0knMAC"===t?i.growers_number=e.coop_membership_number?e.coop_membership_number:"":i.coop_membership_number=e.coop_membership_number?e.coop_membership_number:"",i}));return(0,S.jsxs)("div",{children:[j>0&&(0,S.jsxs)("div",{className:"active-participants-dialog",children:[(0,S.jsxs)("p",{children:["You currently have ",(0,S.jsx)("strong",{children:j})," participants who have not been sent to CommCare. Please download the participant list, review the database, and ensure all information is verified before syncing with CommCare."]}),(0,S.jsx)("button",{className:"take-action-button",onClick:function(){return function(){return(n=n||(0,o.Z)((0,a.Z)().mark((function e(){return(0,a.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return N(!0),e.prev=1,e.next=4,X({variables:{projectId:t}});case 4:return e.next=6,M();case 6:N(!1),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),console.log(e.t0),N(!1);case 13:case"end":return e.stop()}}),e,null,[[1,9]])})))).apply(this,arguments)}()},disabled:C,children:C?"Processing...":"Send to Commcare"})]}),(0,S.jsxs)("div",{className:"flex__heading",children:[(0,S.jsx)("h1",{className:"module__heading",children:"Registered Farmers View"})," ",("super_admin"===(null===ee||void 0===ee?void 0:ee.role)||"ci_leadership"===(null===ee||void 0===ee?void 0:ee.role)||"senior_business_advisor"===(null===ee||void 0===ee?void 0:ee.role)||"project_manager"===(null===ee||void 0===ee?void 0:ee.role)||"mel_analyst"===(null===ee||void 0===ee?void 0:ee.role))&&(0,S.jsx)(m.Qvc,{title:"Upload New Participants",style:{fontSize:"30px",cursor:"pointer",marginLeft:"10px",fill:"#00A5A3"},onClick:function(){return g(!0)}})," "]}),ne.length>0?(0,S.jsx)(u.Z,{columns:te,data:re,tableRowItem:"participants",allAttendances:U,selectedProject:t}):(0,S.jsx)("div",{className:"no__data",children:(0,S.jsx)("h1",{style:{fontSize:"20px"},children:"No Registered Farmers Yet"})}),(0,S.jsx)(I,{open:h,setOpen:g,navigatedProject:p.find((function(e){return e.sf_project_id===t})).project_name,sfProjectId:t})]})}}}]);
//# sourceMappingURL=718.f8878833.chunk.js.map