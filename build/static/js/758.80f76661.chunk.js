"use strict";(self.webpackChunkmypima_front=self.webpackChunkmypima_front||[]).push([[758],{51494:function(e,n,t){t.r(n),t.d(n,{default:function(){return E}});var r,a,i,s,o,c,l,d=t(74165),u=t(15861),m=t(29439),p=t(72791),_=t(81918),f=t(65770),h=t(56355),g=t(93433),x=t(16029),j=t(20890),b=t(19658),v=t(94294),y=t(5289),Z=t(39157),P=t(97123),w=t(21246),S=t(78820),k=t(7692),C=t(84376),I=t(32543),N=t(64802),B=t(30168),A=t(9383),F=((0,A.Ps)(r||(r=(0,B.Z)(["\n  query GetParticipantsAttendanceByProject($projectId: String!) {\n    getParticipantsByProject(project_id: $projectId) {\n      message\n      status\n      participants {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        age\n        coffee_tree_numbers\n        coop_membership_number\n        phone_number\n        hh_number\n        ffg_id\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n        create_in_commcare\n      }\n    }\n    getAttendances(project_id: $projectId) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_name\n        attendance_date\n        attendance_status\n        session_id\n        module_name\n        module_number\n        module_id\n      }\n    }\n  }\n"]))),(0,A.Ps)(a||(a=(0,B.Z)(["\n  query GetParticipantsAttendanceByProject($projectId: String!) {\n    getParticipantsByProject(project_id: $projectId) {\n      message\n      status\n      participants {\n        p_id\n        first_name\n        middle_name\n        last_name\n        gender\n        age\n        coffee_tree_numbers\n        number_of_coffee_plots\n        coop_membership_number\n        phone_number\n        hh_number\n        ffg_id\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n        create_in_commcare\n      }\n    }\n  }\n"])))),D=((0,A.Ps)(i||(i=(0,B.Z)(["\n  query GetParticipantsByGroup($tgId: String!) {\n    getParticipantsByGroup(tg_id: $tgId) {\n      message\n      status\n      participants {\n        p_id\n        full_name\n        gender\n        location\n        tns_id\n        status\n        farmer_trainer\n        business_advisor\n        project_name\n        training_group\n        household_id\n        primary_household_member\n      }\n    }\n  }\n"]))),(0,A.Ps)(s||(s=(0,B.Z)(["\n  query GetAttendanceByParticipant($participantId: String!) {\n    getAttendanceByParticipant(participant_id: $participantId) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_name\n        attendance_date\n        attendance_status\n        session_id\n      }\n    }\n  }\n"]))),(0,A.Ps)(o||(o=(0,B.Z)(["\n  mutation UploadParticipants($partsFile: Upload!) {\n    uploadParticipants(parts_file: $partsFile) {\n      message\n      status\n      file\n    }\n  }\n"])))),$=(0,A.Ps)(c||(c=(0,B.Z)(["\n  mutation SyncParticipantsWithCOMMCARE($projectId: String!) {\n    syncParticipantsWithCOMMCARE(project_id: $projectId) {\n      message\n      status\n    }\n  }\n"]))),O=t(80184),G=["Project","first_name","last_name","gender","age","coffee_tree_numbers","farmer_sf_id","tns_id","hh_number","sf_household_id","farmer_number","ffg_id","training_group","status"],z=function(e){var n,t,r=e.open,a=e.setOpen,i=e.navigatedProject,s=e.sfProjectId,o=(0,p.useState)(null),c=(0,m.Z)(o,2),l=c[0],f=c[1],B=(0,p.useState)(null),A=(0,m.Z)(B,2),$=(A[0],A[1]),z=(0,p.useState)([]),M=(0,m.Z)(z,2),T=M[0],U=M[1],E=(0,p.useState)([]),R=(0,m.Z)(E,2),q=R[0],V=R[1],H=(0,p.useState)(null),J=(0,m.Z)(H,2),W=J[0],L=J[1],K=(0,p.useState)(!1),Q=(0,m.Z)(K,2),Y=Q[0],X=Q[1],ee=(0,C.D)(D),ne=(0,m.Z)(ee,1)[0],te=(0,I.a)(F,{variables:{projectId:s}}),re=function(e){var n=new FileReader;n.onload=function(n){var t=n.target.result.split(/\r\n|\n/),r=t.map((function(e){return e.split(",").map((function(e){return e.replace(/^"(.*)"$/,"$1")}))}));f({filename:e.name,size:e.size,type:e.type,data:r.length>0?r:t}),U(r[0])},n.readAsText(e)};(0,p.useEffect)((function(){l&&(l.data&&l.data.length<2||ae(l))}),[l,T]);var ae=function(e){var n=e.data.map((function(e){return e[T.indexOf("Project")]})).filter((function(e){return e}));V((0,g.Z)(new Set(n)))},ie=function(e,n){"backdropClick"!==n&&"escapeKeyDown"!==n&&se()},se=function(){f(null),a(!1)},oe=function(e,n,t){var r=n.indexOf("Project"),a=e.data.filter((function(e){return e[r]===t})),i="".concat(n.join(","),"\n").concat(a.join("\n"));return new File([i],e.filename,{type:"text/csv"})},ce=function(e){return(t=t||(0,u.Z)((0,d.Z)().mark((function e(n){var t;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.next=3,ne({variables:{partsFile:n}});case 3:return t=e.sent,e.next=6,te.refetch();case 6:L(t.data.uploadParticipants),200===t.data.uploadParticipants.status&&setTimeout((function(){window.location.reload()}),5e3),e.next=14;break;case 10:e.prev=10,e.t0=e.catch(0),console.error(e.t0),L({status:500,message:"Something went wrong. Please try again."});case 14:return e.prev=14,X(!1),e.finish(14);case 17:case"end":return e.stop()}}),e,null,[[0,10,14,17]])})))).apply(this,arguments)},le=function(){var e=W.file;W.message;if(e){var n=atob(e),t=new Array(n.length).fill().map((function(e,t){return n.charCodeAt(t)})),r=new Uint8Array(t),a=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});(0,N.saveAs)(a,"error_file.xlsx")}else console.error("No file found in the upload result.")},de=function(e){return e>1e6?"".concat((e/1e6).toFixed(2)," MB"):"".concat((e/1e3).toFixed(2)," KB")},ue=function(e){return e.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")};return(0,O.jsxs)(y.Z,{open:r,onClose:ie,children:[(0,O.jsx)(Z.Z,{children:l?W?(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},className:"file-info",children:[(0,O.jsx)(j.Z,{variant:"body2",children:(0,O.jsx)(b.Z,{severity:200===W.status?"success":"error",children:W.message})}),200!==W.status&&W.file&&(0,O.jsx)(v.Z,{onClick:le,variant:"contained",color:"primary",children:"Download Error File"})]}):T.filter((function(e){return G.includes(e)})).length!==G.length?(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,O.jsxs)(j.Z,{variant:"body1",children:[(0,O.jsx)(k.tJu,{style:{fontSize:"2rem",color:"#B90101"}})," File must contain all required columns:"]}),(0,O.jsx)(j.Z,{variant:"body2",sx:{display:"flex",alignItems:"center",flexWrap:"wrap"},children:G.filter((function(e){return!T.includes(e)})).map((function(e,n){return(0,O.jsx)(_.Z,{label:e,sx:{margin:"5px 0.5rem"},color:"primary",variant:"outlined"},n)}))}),(0,O.jsx)("div",{className:"upload_actions",children:(0,O.jsx)(S.SV5,{onClick:function(){return f(null)},className:"back__icon",title:"Back to Upload New File"})})]}):l.data.length-2<1?(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,O.jsxs)(j.Z,{variant:"body1",sx:{fontStyle:"italic"},children:[(0,O.jsx)(k.tJu,{style:{fontSize:"1.5rem",color:"#B90101"}})," There are no records in the file. Please upload a file with data."]}),(0,O.jsx)("div",{className:"upload_actions",children:(0,O.jsx)(S.SV5,{onClick:function(){return f(null)},className:"back__icon",title:"Back to Upload New File"})})]}):q.includes(i)?(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},className:"file-info",children:[(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,O.jsxs)(j.Z,{variant:"body2",children:[(0,O.jsx)("strong",{children:"Name:"})," ",l.filename]}),(0,O.jsxs)(j.Z,{variant:"body2",children:[(0,O.jsx)("strong",{children:"Size:"})," ",de(l.size)]}),(0,O.jsxs)(j.Z,{variant:"body2",children:[(0,O.jsx)("strong",{children:"Type:"})," ",l.type]}),(0,O.jsxs)(j.Z,{variant:"body2",children:[(0,O.jsx)("strong",{children:"Total Records:"})," ",ue(l.data.length-2)]}),q.length>1&&(0,O.jsxs)(j.Z,{variant:"body4",sx:{marginBottom:"10px"},children:["Only records for ",(0,O.jsxs)("strong",{children:[i," (",l.data.filter((function(e){return e[T.indexOf("Project")]===i})).length," records)"]})," will be processed from this file."]})]}),(0,O.jsx)("div",{className:"upload_actions",children:Y?(0,O.jsx)(j.Z,{variant:"body2",sx:{marginBottom:"10px",width:"100%",textAlign:"center"},children:(0,O.jsx)("em",{style:{fontWeight:"bold",color:"#6C757D"},children:"Data are being processed, wait..."})}):(0,O.jsxs)(O.Fragment,{children:[(0,O.jsx)(S.SV5,{onClick:function(){return f(null)},className:"back__icon",title:"Back to Upload New File"}),(0,O.jsx)(h.Qvc,{title:"Proceed Records Processing",className:"upload__icon",onClick:function(){return(n=n||(0,u.Z)((0,d.Z)().mark((function e(){var n;return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!Y){e.next=2;break}return e.abrupt("return");case 2:return X(!0),L(null),n=oe(l,T,i),e.next=7,ce(n);case 7:case"end":return e.stop()}}),e)})))).apply(this,arguments)}})]})})]}):(0,O.jsxs)(x.Z,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[(0,O.jsxs)(j.Z,{variant:"body1",sx:{fontStyle:"italic"},children:[(0,O.jsx)(k.tJu,{style:{fontSize:"3rem",color:"#B90101"}})," The project(s) in the file does not match the project you are currently navigating. Please upload a file with the correct project."]}),(0,O.jsx)("div",{className:"upload_actions",children:(0,O.jsx)(S.SV5,{onClick:function(){return f(null)},className:"back__icon",title:"Back to Upload New File"})})]}):(0,O.jsx)(w.b,{label:"Drag and drop or browse a file to upload. File must be: ",handleChange:function(e){$(e),L(null),re(e)},name:"file",types:["csv"]})}),(0,O.jsx)(P.Z,{children:(0,O.jsx)(v.Z,{onClick:ie,disabled:Y,children:"Cancel"})})]})},M=(0,A.Ps)(l||(l=(0,B.Z)(["\n  query GetAttendances($projectId: String!) {\n    getAttendances(project_id: $projectId) {\n      message\n      status\n      attendance {\n        attendance_id\n        participant_id\n        attendance_name\n        attendance_date\n        attendance_status\n        session_id\n        module_name\n        module_number\n        module_id\n      }\n    }\n  }\n"]))),T=t(56789),U=t(61889),E=function(e){var n,t=e.selectedProject,r=e.trainingGroups,a=e.projects,i=(0,p.useState)(!1),s=(0,m.Z)(i,2),o=s[0],c=s[1],l=(0,p.useState)(),g=(0,m.Z)(l,2),x=g[0],j=g[1],b=(0,p.useState)(!1),v=(0,m.Z)(b,2),y=v[0],Z=v[1],P=(0,I.a)(F,{variables:{projectId:t},skip:!t}),w=P.data,S=P.loading,k=P.error,N=P.refetch,B=(0,I.a)(M,{variables:{projectId:t},skip:!t}),A=B.data,D=B.loading,G=B.error,E=(0,C.D)($),R=(0,m.Z)(E,1)[0],q=JSON.parse(window.localStorage.getItem("myPimaUserData"));(0,p.useEffect)((function(){if(w&&200===w.getParticipantsByProject.status){var e=w.getParticipantsByProject.participants.filter((function(e){return"false"===e.create_in_commcare}));j(e.length)}}),[w]);if(S||D)return(0,O.jsxs)(U.ZP,{container:!0,direction:"column",justifyContent:"center",alignItems:"center",style:{height:"100vh"},children:[(0,O.jsx)(T.Z,{color:"#0D3C61",size:15}),(0,O.jsx)("em",{style:{color:"#0D3C61"},children:"Loading Participants and Attendances..."})]});if(k||G)return(0,O.jsx)(U.ZP,{container:!0,direction:"column",justifyContent:"center",alignItems:"center",style:{height:"100vh"},children:(0,O.jsxs)("em",{style:{color:"red"},children:["Error loading data: ",(null===k||void 0===k?void 0:k.message)||(null===G||void 0===G?void 0:G.message)]})});var V=w.getParticipantsByProject.participants,H=A.getAttendances.attendance,J=[{id:"num",name:"No.",selector:function(e){return e.num},sortable:!0},{id:"full_name",name:"Full Name",selector:function(e){return e.first_name+" "+e.last_name},sortable:!0},{id:"gender",name:"Gender",selector:function(e){return"m"===e.gender?"Male":"Female"},sortable:!0},{id:"location",name:"Location",selector:function(e){return e.location},sortable:!0},{id:"tns_id",name:"TNS ID",selector:function(e){return e.tns_id},sortable:!0},{id:"training_group",name:"Training Group",selector:function(e){return e.training_group},sortable:!0},{id:"household_id",name:"HH Number",selector:function(e){return e.hh_number},sortable:!0},{id:"primary_household_member",name:"Primary HouseHold Member",selector:function(e){return(0,O.jsx)("div",{children:"1"===e.farmer_number?(0,O.jsx)(_.Z,{label:"1",color:"success",variant:"outlined"}):(0,O.jsx)(_.Z,{label:"2",color:"error",variant:"outlined"})})},sortable:!0},{id:"farmer_trainer",name:"Farmer Trainer",selector:function(e){return e.farmer_trainer},sortable:!0},{id:"business_advisor",name:"Business Advisor",selector:function(e){return e.business_advisor},sortable:!0}],W=V.map((function(e,n){var i,s={num:n+1,Project:a.find((function(e){return e.sf_project_id===t})).project_name,p_id:e.p_id,first_name:e.first_name,middle_name:e.middle_name?e.middle_name:"",last_name:e.last_name?e.last_name:"",gender:e.gender,age:e.age,coffee_tree_numbers:e.coffee_tree_numbers,phone_number:e.phone_number,farmer_sf_id:e.p_id,hh_number:e.hh_number,sf_household_id:e.household_id,ffg_id:e.ffg_id,location:e.location,tns_id:e.tns_id,training_group:r&&r.length>0&&(null===(i=r.find((function(n){return n.tg_id===e.training_group})))||void 0===i?void 0:i.tg_name)||"N/A",farmer_number:e.primary_household_member,status:e.status,farmer_trainer:e.farmer_trainer,business_advisor:e.business_advisor,create_in_commcare:e.create_in_commcare,number_of_coffee_plots:e.number_of_coffee_plots};return"a0EOj000002FMGnMAO"===t||"a0EOj000002C7ivMAC"===t?s.national_identification_id=e.coop_membership_number?e.coop_membership_number:"":s.coop_membership_number=e.coop_membership_number?e.coop_membership_number:"",s}));return(0,O.jsxs)("div",{children:[x>0&&(0,O.jsxs)("div",{className:"active-participants-dialog",children:[(0,O.jsxs)("p",{children:["You currently have ",(0,O.jsx)("strong",{children:x})," participants who have not been sent to CommCare. Please download the participant list, review the database, and ensure all information is verified before syncing with CommCare."]}),(0,O.jsx)("button",{className:"take-action-button",onClick:function(){return function(){return(n=n||(0,u.Z)((0,d.Z)().mark((function e(){return(0,d.Z)().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return Z(!0),e.prev=1,e.next=4,R({variables:{projectId:t}});case 4:return e.next=6,N();case 6:Z(!1),e.next=13;break;case 9:e.prev=9,e.t0=e.catch(1),console.log(e.t0),Z(!1);case 13:case"end":return e.stop()}}),e,null,[[1,9]])})))).apply(this,arguments)}()},disabled:y,children:y?"Processing...":"Send to Commcare"})]}),(0,O.jsxs)("div",{className:"flex__heading",children:[(0,O.jsx)("h1",{className:"module__heading",children:"Registered Farmers View"})," ",("super_admin"===(null===q||void 0===q?void 0:q.role)||"ci_leadership"===(null===q||void 0===q?void 0:q.role)||"senior_business_advisor"===(null===q||void 0===q?void 0:q.role)||"project_manager"===(null===q||void 0===q?void 0:q.role)||"mel_analyst"===(null===q||void 0===q?void 0:q.role))&&(0,O.jsx)(h.Qvc,{title:"Upload New Participants",style:{fontSize:"30px",cursor:"pointer",marginLeft:"10px",fill:"#00A5A3"},onClick:function(){return c(!0)}})," "]}),V.length>0?(0,O.jsx)(f.Z,{columns:J,data:W,tableRowItem:"participants",allAttendances:H,selectedProject:t}):(0,O.jsx)("div",{className:"no__data",children:(0,O.jsx)("h1",{style:{fontSize:"20px"},children:"No Registered Farmers Yet"})}),(0,O.jsx)(z,{open:o,setOpen:c,navigatedProject:a.find((function(e){return e.sf_project_id===t})).project_name,sfProjectId:t})]})}}}]);
//# sourceMappingURL=758.80f76661.chunk.js.map