(self.webpackChunkmypima_front=self.webpackChunkmypima_front||[]).push([[789],{23789:(e,t,i)=>{"use strict";i.r(t),i.d(t,{default:()=>j});var s=i(65043),n=i(88250),r=i(31881),a=i(6410),o=i(15527),c=i(23768),l=i(72450),d=i(94496),m=i(32393),u=i(73216),h=i(70579);const v=[{name:"Compost"},{name:"Compost BU"},{name:"Main Stems"},{name:"Shade Management"},{name:"Weeding"},{name:"Record Book"},{name:"Stumping"}],p=()=>(0,h.jsxs)("div",{className:"loading-container",children:[(0,h.jsx)("div",{className:"spinner"}),(0,h.jsx)("p",{children:"Loading, please wait..."})]}),g=e=>{let{message:t}=e;return(0,h.jsx)("div",{className:"error-container",children:(0,h.jsxs)("div",{className:"error-message",children:[(0,h.jsx)("h3",{children:"Something went wrong"}),(0,h.jsx)("p",{children:t}),(0,h.jsx)("button",{onClick:()=>window.location.reload(),children:"Try Again"})]})})},f=e=>{var t,i;let{practice:s,onSelect:r,projectId:a}=e;const{data:c,loading:l,error:d}=(0,n.I)(o.S7,{variables:{projectId:a,practiceName:s.name}});return(0,h.jsxs)("div",{className:"practice-card",onClick:()=>r(s),children:[(0,h.jsx)("h3",{children:s.name}),l&&(0,h.jsx)(p,{}),d&&(0,h.jsx)(g,{message:d.message}),!l&&!d&&(0,h.jsxs)("div",{className:"progress",children:[(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Reviewed:"})," ",(null===c||void 0===c||null===(t=c.getBestPracticeReviewStats)||void 0===t?void 0:t.reviewedVisits)||0]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Remaining:"})," ",(null===c||void 0===c||null===(i=c.getBestPracticeReviewStats)||void 0===i?void 0:i.remainingVisits)||0]})]})]})},j=()=>{const{activeProject:e,userId:t}=(0,u.KC)(),[i,j]=(0,s.useState)(null),[x,w]=(0,s.useState)(0),[b,N]=(0,s.useState)([]),[y,_]=(0,s.useState)([]),[R,S]=(0,s.useState)({}),[k,A]=(0,s.useState)({}),[C,E]=(0,s.useState)(null),[B,P]=(0,s.useState)({}),[L,F]=(0,s.useState)(!1),[I,M]=(0,s.useState)(!1),{data:T,loading:U,error:O}=(0,n.I)(o.hz,{variables:{projectId:e}}),{data:V,loading:D,error:q,refetch:H}=(0,n.I)(o.lg,{variables:{projectId:e,practiceName:i?i.name:"",page:0,pageSize:1e3},skip:!i,fetchPolicy:"network-only"}),[Y]=(0,r.n)(o.YI),[$]=(0,a._)(o.Ee,{fetchPolicy:"network-only"});(0,s.useEffect)((()=>{V&&V.getPaginatedReviews&&N(V.getPaginatedReviews)}),[V]),(0,s.useEffect)((()=>{if(i){const e=b.filter((e=>e.BestPractices.some((e=>e.practice_name===i.name))));_(e)}}),[i,b]);const z=e=>{j(e),w(0),S({}),A({}),H({practiceName:e.name})},K=(e,t)=>{const i=atob(e),s=[];for(let n=0;n<i.length;n+=512){const e=i.slice(n,n+512),t=new Array(e.length);for(let i=0;i<e.length;i++)t[i]=e.charCodeAt(i);const r=new Uint8Array(t);s.push(r)}return new Blob(s,{type:t})};if(U)return(0,h.jsx)(m.A,{});if(O)return(0,h.jsx)("div",{style:{display:"flex",justifyContent:"center",alignItems:"center",height:"100vh"},children:(0,h.jsx)(d.A,{color:"error",children:"Error loading data"})});const{totalSampledVisits:W,totalReviewed:X,remainingVisits:G}=T.getSampledVisitsStats;return(0,h.jsx)("div",{className:"farm-visit-app",children:i?(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:"indicator",children:(0,h.jsx)("span",{onClick:()=>{j(null),w(0),S({}),A({})},className:"indicator-link",children:"Back to Practice Overview"})}),(0,h.jsxs)("h2",{className:"sub-header",children:["Reviewing ",i.name]}),D&&(0,h.jsx)(m.A,{}),q&&(0,h.jsx)(g,{message:q.message}),!D&&!q&&y.length>0&&(0,h.jsxs)(h.Fragment,{children:[(0,h.jsx)("div",{className:"visit-list",children:y.slice(5*x,5*(x+1)).map((e=>{var t;const s=e.BestPractices.find((e=>e.practice_name===i.name)),[n,r]=(null===s||void 0===s||null===(t=s.image_url)||void 0===t?void 0:t.split("/").slice(-2))||[];return(0,h.jsxs)("div",{className:"visit-item",children:[(0,h.jsxs)("div",{className:"visit-details",children:[(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Farmer PIMA ID:"})," ",e.farmer_pima_id]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Farmer TNS ID:"})," ",e.farmer_tns_id]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Date Visited:"})," ",e.date_visited]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Farmer Name:"})," ",e.farmer_name]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Farmer Trainer:"})," ",e.farmer_trainer]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Question:"})," ",(null===s||void 0===s?void 0:s.question)||"N/A"]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Observation:"})," ",(null===s||void 0===s?void 0:s.answer)||"N/A"]})]}),(0,h.jsxs)("div",{className:"visit-image",children:[B[r]&&(0,h.jsx)(p,{}),(0,h.jsx)("img",{src:null!==s&&void 0!==s&&s.image_url?`https://api.pima.ink/image/${n}/${r}`:"https://via.placeholder.com/150",alt:"Farm Visit",style:{display:B[r]?"none":"block"},onLoad:()=>(e=>{P((t=>({...t,[e]:!1})))})(r),onError:()=>(e=>{P((t=>({...t,[e]:!1})))})(r),onClick:()=>((e,t)=>{E(`https://api.pima.ink/image/${e}/${t}`)})(n,r)})]}),(0,h.jsxs)("div",{className:"answer-field",children:[(0,h.jsx)("label",{children:"Correct Answer?"}),(0,h.jsxs)("select",{value:R[e.visit_id]||"",onChange:t=>{return i=e.visit_id,s=t.target.value,void S((e=>({...e,[i]:s})));var i,s},children:[(0,h.jsx)("option",{value:"",children:"-- Select --"}),(0,h.jsx)("option",{value:"Yes",children:"Yes"}),(0,h.jsx)("option",{value:"No",children:"No"}),(0,h.jsx)("option",{value:"Unclear",children:"Unclear"})]})]}),(0,h.jsxs)("div",{className:"comment-field",children:[(0,h.jsx)("label",{children:"Comments:"}),(0,h.jsx)("textarea",{value:k[e.visit_id]||"",onChange:t=>{return i=e.visit_id,s=t.target.value,void A((e=>({...e,[i]:s})));var i,s},placeholder:"No"===R[e.visit_id]?"Required is answer is 'No'":"Required",required:"No"===R[e.visit_id],className:"No"!==R[e.visit_id]||k[e.visit_id]?"":"error"}),"No"===R[e.visit_id]&&!k[e.visit_id]&&(0,h.jsx)("p",{className:"error-message",children:"Comment is required for 'No' answers"})]})]},e.visit_id)}))}),(0,h.jsxs)("div",{className:"pagination-info",children:["Reviewing"," ",Math.min(5*(x+1),y.length)," of"," ",y.length," records"]}),(0,h.jsxs)("div",{className:"pagination-controls",children:[(0,h.jsx)("button",{disabled:0===x,onClick:()=>w(x-1),children:"Previous"}),(0,h.jsxs)("span",{className:"current-page",children:["Page ",x+1," of"," ",Math.ceil(y.length/5)]}),(0,h.jsx)("button",{disabled:x>=Math.floor(y.length/5),onClick:()=>w(x+1),children:"Next"})]}),(0,h.jsx)("button",{className:"submit-button",onClick:()=>{const e=y.slice(5*x,5*(x+1)),s=e.every((e=>R[e.visit_id])),n=e.every((e=>"Yes"===R[e.visit_id]||"No"===R[e.visit_id]&&k[e.visit_id]));if(!s)return void c.oR.error("Please fill out 'Correct Answer?' for all records before submitting.");if(!n)return void c.oR.error("Please provide comments for all records with 'No' answers.");const r=e.map((e=>({practice_id:e.BestPractices.find((e=>e.practice_name===i.name)).practice_id,correct_answer:R[e.visit_id].toLowerCase(),comment:k[e.visit_id]||"",user_id:t})));F(!0),Y({variables:{input:r}}).then((e=>{F(!1),e.data.submitBatch.success?(c.oR.success("Batch submitted successfully!"),S({}),A({}),w(0),H({fetchPolicy:"network-only"})):c.oR.error("Failed to submit batch: "+e.data.submitBatch.message)})).catch((e=>{F(!1),console.error("Error submitting batch:",e),c.oR.error("An error occurred while submitting the batch.")}))},disabled:L,children:L?"Submitting...":"Submit Batch"})]}),C&&(0,h.jsx)("div",{className:"image-modal",onClick:()=>{E(null)},children:(0,h.jsx)("img",{src:C,alt:"Fullscreen Farm Visit"})})]}):(0,h.jsxs)(h.Fragment,{children:[(0,h.jsxs)("div",{className:"dashboard-header",children:[(0,h.jsxs)("div",{className:"dashboard-info",children:[(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Total Sampled Visits:"})," ",W]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Total Reviewed:"})," ",X]}),(0,h.jsxs)("p",{children:[(0,h.jsx)("strong",{children:"Remaining Visits:"})," ",G]})]}),(0,h.jsx)("button",{className:"download-button",onClick:()=>{e?(M(!0),$({variables:{projectId:e}}).then((e=>{const{generateFarmVisitReport:t}=e.data;if(200===t.status&&t.file){const e=t.file.split(",")[1],i=K(e,"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet");(0,l.saveAs)(i,"farm_visit_statistics.xlsx"),c.oR.success("Download started.")}else c.oR.error(t.message||"Failed to generate report.");M(!1)})).catch((e=>{console.error("Error generating report:",e),c.oR.error("An error occurred while generating the report."),M(!1)}))):c.oR.error("No project selected.")},disabled:I,children:I?"Downloading...":"Download Report"})]}),(0,h.jsx)("h1",{className:"dashboard-title",children:"Choose Adoption Method to Review"}),(0,h.jsx)("div",{className:"practices-container",children:v.map((t=>(0,h.jsx)(f,{practice:t,projectId:e,onSelect:z},t.name)))})]})})}},72450:function(e,t,i){var s,n,r;n=[],void 0===(r="function"===typeof(s=function(){"use strict";function t(e,t){return"undefined"==typeof t?t={autoBom:!1}:"object"!=typeof t&&(console.warn("Deprecated: Expected third argument to be a object"),t={autoBom:!t}),t.autoBom&&/^\s*(?:text\/\S*|application\/xml|\S*\/\S*\+xml)\s*;.*charset\s*=\s*utf-8/i.test(e.type)?new Blob(["\ufeff",e],{type:e.type}):e}function s(e,t,i){var s=new XMLHttpRequest;s.open("GET",e),s.responseType="blob",s.onload=function(){c(s.response,t,i)},s.onerror=function(){console.error("could not download file")},s.send()}function n(e){var t=new XMLHttpRequest;t.open("HEAD",e,!1);try{t.send()}catch(e){}return 200<=t.status&&299>=t.status}function r(e){try{e.dispatchEvent(new MouseEvent("click"))}catch(s){var t=document.createEvent("MouseEvents");t.initMouseEvent("click",!0,!0,window,0,0,0,80,20,!1,!1,!1,!1,0,null),e.dispatchEvent(t)}}var a="object"==typeof window&&window.window===window?window:"object"==typeof self&&self.self===self?self:"object"==typeof i.g&&i.g.global===i.g?i.g:void 0,o=a.navigator&&/Macintosh/.test(navigator.userAgent)&&/AppleWebKit/.test(navigator.userAgent)&&!/Safari/.test(navigator.userAgent),c=a.saveAs||("object"!=typeof window||window!==a?function(){}:"download"in HTMLAnchorElement.prototype&&!o?function(e,t,i){var o=a.URL||a.webkitURL,c=document.createElement("a");t=t||e.name||"download",c.download=t,c.rel="noopener","string"==typeof e?(c.href=e,c.origin===location.origin?r(c):n(c.href)?s(e,t,i):r(c,c.target="_blank")):(c.href=o.createObjectURL(e),setTimeout((function(){o.revokeObjectURL(c.href)}),4e4),setTimeout((function(){r(c)}),0))}:"msSaveOrOpenBlob"in navigator?function(e,i,a){if(i=i||e.name||"download","string"!=typeof e)navigator.msSaveOrOpenBlob(t(e,a),i);else if(n(e))s(e,i,a);else{var o=document.createElement("a");o.href=e,o.target="_blank",setTimeout((function(){r(o)}))}}:function(e,t,i,n){if((n=n||open("","_blank"))&&(n.document.title=n.document.body.innerText="downloading..."),"string"==typeof e)return s(e,t,i);var r="application/octet-stream"===e.type,c=/constructor/i.test(a.HTMLElement)||a.safari,l=/CriOS\/[\d]+/.test(navigator.userAgent);if((l||r&&c||o)&&"undefined"!=typeof FileReader){var d=new FileReader;d.onloadend=function(){var e=d.result;e=l?e:e.replace(/^data:[^;]*;/,"data:attachment/file;"),n?n.location.href=e:location=e,n=null},d.readAsDataURL(e)}else{var m=a.URL||a.webkitURL,u=m.createObjectURL(e);n?n.location=u:location.href=u,n=null,setTimeout((function(){m.revokeObjectURL(u)}),4e4)}});a.saveAs=c.saveAs=c,e.exports=c})?s.apply(t,n):s)||(e.exports=r)}}]);
//# sourceMappingURL=789.18f0deee.chunk.js.map